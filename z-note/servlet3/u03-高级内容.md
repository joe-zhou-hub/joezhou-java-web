# 1. 过滤器

**概念：** servlet过滤器作用于 `service()` 前后，与服务器同生共死：
- 开发过滤器类并实现 `javax.servlet.Filter` 接口。
- 重写过滤器类的 `init()/destroy()/doFilter()`：初始化/销毁/过滤器任务方法：
    - `doFilter()` 中获取 `HttpServletRequest` 和 `HttpServletResponse` 对象。
    - `doFilter()` 中为请求和响应对象统一转码。
    - `doFilter()` 中使用 `chain.doFilter()` 以放行请求到 `service()` 中。
- 注解方式配置：为过滤器类添加 `@WebFilter` 并使用 `value` 属性指定过滤规则。
- XML方式配置：`web.xml` 中：
    - 使用 `<filter>/<filter-name>/<filter-class>` 配置过滤器类。
    - 使用 `<filter-mapping>/<filter-name>/<url-pattern>` 配置过滤规则。
- 开发 `FilterTestServlet` 类：接收中文参数，并写回客户端。

> 过滤规则中不支持前模糊如 `/*/api` 或 `/*User`，但支持后模糊如 `/user*` 或 `/api/*`。

**源码：** /servlet3/
- res: `web.xml`
- src: `c.j.filter.EncodingAnnotationFilter`
- src: `c.j.filter.EncodingXmlFilter`
- src: `c.j.filter.EncodingServlet`
- psm: `{{tomcat}}/servlet3/api/encoding?name=赵四`

## 1.1 非法请求案例

**需求：** 
- 已登录状态下，所有 `/api/*` 路径，都属于正常请求。
- 未登录状态下，除了 `/api/login` 路径之外的所有 `/api/*` 路径，都属于非法请求。

**源码：** /servlet3/
- src: `c.j.filter.IllegalRequestFilter`
- src: `c.j.filter.IllegalRequestServlet`
- psm: `{{tomcat}}/servlet3/api/encoding?name=赵四`，非法请求。
- psm: `{{tomcat}}/servlet3/api/login?name=admin`，登陆成功。
- psm: `{{tomcat}}/servlet3/api/encoding?name=赵四`，允许访问。

# 2. 监听器

**概念：** servlet监听器与服务器同生共死，每种监听器都有不同的使命：
- 开发监听器类并实现 `javax.servlet.ServletContextListener` 接口，监视服务器的生死。
- 重写监听器类的监听方法：
    - `contextInitialized()`：服务器启动时触发。
    - `contextDestroyed()`：服务器关闭时触发。
- 注解方式配置：为监听器类添加 `@WebListener`。
- XML方式配置：`web.xml` 中使用 `<listener>/<listener-class>` 配置监听器类。

**源码：** /servlet3/
- res: `web.xml`
- src: `c.j.listener.XmlListener`
- src: `c.j.listener.AnnotationListener`

## 2.1 访客计数案例

**需求：** 某客户端登录成功时，回写："当前第x个人登录了您的网站！"

**源码：** /servlet3/
- src: `c.j.listener.VisitorCountListener`
- src: `c.j.listener.VisitorCountServlet`
- psm: `{{tomcat}}/servlet3/api/visitor-count?meta=login`

## 2.2 重复登录案例

**需求：** 某客户端重复登陆同一账号时，回写："不允许重复登陆！"

**源码：** /servlet3/
- src: `c.j.listener.RepeatLoginListener`
- src: `c.j.listener.RepeatLoginFilter`
- src: `c.j.listener.RepeatLoginServlet`
- src: `c.j.listener.ExitLoginServlet`
- psm: `{{tomcat}}/servlet3/api/repeat-login?meta=login`
- psm: `{{tomcat}}/servlet3/api/exit-login?meta=login`

## 2.3 其他监听器

**概念：** servlet中提供了8中类型的监听：
- `ServletRequestListener`：监听 `HttpServletRequest` 的生死：
    - `requestInitialized()`：请求出生时触发。
    - `requestDestroyed()`：请求死亡时触发。
- `ServletRequestAttributeListener`：监听 `HttpServletRequest` 域中属性：
    - `attributeAdded()`：域中属性被添加时触发。
    - `attributeRemoved()`：域中属性被移除时触发。
    - `attributeReplaced()`：域中属性被修改时触发。
- `HttpSessionListener`：监听 `HttpSession` 的生死：
    - `sessionCreated()`：会话出生时触发。
    - `sessionDestroyed()`：会话死亡时触发。
- `HttpSessionAttributeListener`：监听 `HttpSession` 域中属性：
    - `attributeAdded()`：域中属性被添加时触发。
    - `attributeRemoved()`：域中属性被移除时触发。
    - `attributeReplaced()`：域中属性被修改时触发。
- `HttpSessionBindingListener`：监听其实现类，该监听不需要配置：
    - `valueBound()`：其实现类加入会话时触发。
    - `valueUnbound()`：其实现类移除会话时触发。
- `HttpSessionActivationListener`：监听 `HttpSession` 的迁移动作：
    - `sessionDidActivate()`：session在一个vm上钝化时触发。
    - `sessionWillPassivate()`：session在另一个vm上激活时触发。
- `ServletContextListener`：监听 `ServletContext` 的出生和死亡：
    - `contextInitialized(ServletContextEvent event)`
    - `contextDestroyed(ServletContextEvent event)`
- `ServletContextAttributeListener`：监听 `ServletContext` 域中属性的增加，删除和替换：
    - `attributeAdded(ServletContextAttributeEvent event)`
    - `attributeRemoved(ServletContextAttributeEvent event)`
    - `attributeReplaced(ServletContextAttributeEvent event)`

**源码：** /servlet3/
- src: `c.j.listener.MyRequestListener`
- src: `c.j.listener.MyRequestServlet`
- src: `c.j.listener.MyRequestAttributeListener`
- src: `c.j.listener.MyRequestAttributeServlet`
- src: `c.j.listener.MySessionListener`
- src: `c.j.listener.MySessionServlet`
- src: `c.j.listener.MySessionAttributeListener`
- src: `c.j.listener.MySessionAttributeServlet`
- src: `c.j.listener.User`
- src: `c.j.listener.MySessionBindingServlet`
- psm: `{{tomcat}}/servlet3/api/my-request`
- psm: `{{tomcat}}/servlet3/api/my-request-attribute`
    - `?meta=add`：测试请求域属性添加操作。
    - `?meta=replace`：测试请求域属性修改操作。
    - `?meta=remove`：测试请求域属性删除操作。
- psm: `{{tomcat}}/servlet3/api/my-session`
    - `?meta=create`：测试创建会话。
    - `?meta=destroy`：测试销毁会话。
- psm: `{{tomcat}}/servlet3/api/my-session-attribute`
    - `?meta=add`：测试请求域属性添加操作。
    - `?meta=replace`：测试请求域属性修改操作。
    - `?meta=remove`：测试请求域属性删除操作。
- psm: `{{tomcat}}/servlet3/api/my-session-binding`
    - `?meta=bound`：测试将对象绑定到会话。
    - `?meta=unbound`：测将对象从会话解绑。